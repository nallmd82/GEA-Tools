<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Page Generator | Golden Eagle Auctions</title>
    
    <!-- JSZip for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        :root {
            --color-black: #242424;
            --color-gold: #BAA342;
            --color-gray-light: #F5F5F5;
            --color-gray-medium: #DDDDDD;
            --color-gray-text: #555555;
            --color-white: #FFFFFF;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--color-black);
            background-color: var(--color-gray-light);
            min-height: 100vh;
            padding: 40px 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 8px;
            color: var(--color-black);
        }
        
        .subtitle {
            color: var(--color-gray-text);
            margin-bottom: 30px;
        }
        
        .card {
            background: var(--color-white);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--color-black);
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-black);
        }
        
        input[type="text"],
        input[type="url"] {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-gray-medium);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: var(--color-gold);
        }
        
        .btn {
            display: inline-block;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background-color: var(--color-gold);
            color: var(--color-black);
        }
        
        .btn-primary:hover {
            background-color: var(--color-black);
            color: var(--color-white);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: var(--color-gray-light);
            color: var(--color-black);
        }
        
        .btn-secondary:hover {
            background-color: var(--color-gray-medium);
        }
        
        .status {
            margin-top: 20px;
            padding: 16px;
            border-radius: 8px;
            display: none;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            display: block;
        }
        
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            display: block;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-gray-medium);
            border-radius: 4px;
            margin-top: 12px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--color-gold);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .preview-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--color-gray-medium);
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .preview-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-item label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            flex: 1;
            margin: 0;
        }
        
        .preview-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-gold);
        }
        
        .preview-item:last-child {
            border-bottom: none;
        }
        
        .preview-item .title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .preview-item .slug {
            font-size: 12px;
            color: var(--color-gray-text);
        }
        
        .preview-item .status-icon {
            font-size: 18px;
            min-width: 90px;
            text-align: right;
        }
        
        .preview-item .status-icon.pending {
            color: var(--color-gray-medium);
        }
        
        .preview-item .status-icon.complete {
            color: #2e7d32;
        }
        
        .preview-item .status-icon.done {
            color: #2e7d32;
        }
        
        .help-text {
            font-size: 13px;
            color: var(--color-gray-text);
            margin-top: 8px;
        }
        
        .step-indicator {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }
        
        .step {
            flex: 1;
            padding: 12px;
            background: var(--color-gray-light);
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-text);
        }
        
        .step.active {
            background: var(--color-gold);
            color: var(--color-black);
        }
        
        .step.complete {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .hidden {
            display: none !important;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü¶Ö Product Page Generator</h1>
        <p class="subtitle">Generate standalone product pages from your Google Sheet</p>
        
        <div class="step-indicator">
            <div class="step active" id="step1">1. Load Data</div>
            <div class="step" id="step2">2. Preview</div>
            <div class="step" id="step3">3. Generate</div>
        </div>
        
        <!-- Step 1: Load Data -->
        <div class="card" id="card-load">
            <h2>Load Your Auction Data</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="font-weight: 600; margin-bottom: 8px; display: block;">Choose how to load data:</label>
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="radio" name="load-method" value="file" checked onchange="toggleLoadMethod()"> Upload CSV file
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="radio" name="load-method" value="url" onchange="toggleLoadMethod()"> Load from URL
                    </label>
                </div>
            </div>
            
            <div id="file-upload-section">
                <label for="csv-file">Select CSV File</label>
                <input type="file" id="csv-file" accept=".csv" style="padding: 12px; border: 2px dashed var(--color-gray-medium); border-radius: 8px; width: 100%; box-sizing: border-box; cursor: pointer;">
                <p class="help-text">Export your Google Sheet as CSV: File ‚Üí Download ‚Üí Comma-separated values (.csv)</p>
            </div>
            
            <div id="url-load-section" style="display: none;">
                <label for="csv-url">Google Sheet CSV URL</label>
                <input type="url" id="csv-url" placeholder="https://docs.google.com/spreadsheets/d/e/.../pub?output=csv" value="https://docs.google.com/spreadsheets/d/1WFlVVSsMSpEx6s4YTUl7xvN_tbQe-oA-3fTZYqSVTgA/export?format=csv&gid=699359384">
                <p class="help-text">Paste the URL from your browser when viewing the Google Sheet. <strong>Note:</strong> URL loading only works when this page is hosted on a web server. If opening locally, use "Upload CSV file" instead.</p>
            </div>
            
            <label for="catalog-url">Catalog Page URL (for "Back to Catalog" links)</label>
            <input type="text" id="catalog-url" placeholder="/auction-catalog" value="/auction-catalog">
            
            <label for="base-url">Product Pages Base URL (folder where pages will live)</label>
            <input type="text" id="base-url" placeholder="/" value="/">
            <p class="help-text">Example: If you enter "/", links will be like "/lot-110-browning-a5"</p>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--color-gray-medium);">
                <label>Auction CTA Link (for "Bid Now" buttons)</label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <select id="saved-auctions" onchange="loadSavedAuction()" style="flex: 1; padding: 12px; border: 1px solid var(--color-gray-medium); border-radius: 8px; font-size: 14px;">
                        <option value="">-- Select saved auction --</option>
                    </select>
                    <button type="button" class="btn btn-secondary" onclick="deleteSavedAuction()" title="Delete selected">üóëÔ∏è</button>
                </div>
                <input type="url" id="cta-url" placeholder="https://goldeneaglelive.auctiontechs.com/auction/123">
                <p class="help-text">Link to the current auction on AuctionTechs. Leave empty to hide CTA buttons.</p>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <input type="text" id="auction-name" placeholder="Auction name (e.g., Q1 2025 Auction)" style="flex: 1;">
                    <button type="button" class="btn btn-secondary" onclick="saveAuction()">üíæ Save</button>
                </div>
            </div>
            
            <button class="btn btn-primary" id="btn-load" onclick="loadData()">Load Data</button>
            
            <div class="status" id="status-load"></div>
        </div>
        
        <!-- Step 2: Preview -->
        <div class="card hidden" id="card-preview">
            <h2>Select Items to Generate (<span id="item-count">0</span> products found)</h2>
            
            <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                <button class="btn btn-secondary" onclick="selectNone()">Select None</button>
                <span id="selected-count" style="color: var(--color-gray-text); font-size: 14px;">0 selected</span>
            </div>
            
            <div class="preview-list" id="preview-list">
                <!-- Items will be inserted here -->
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
                <button class="btn btn-primary" id="btn-generate" onclick="generatePages()">Generate Selected Pages</button>
            </div>
        </div>
        
        <!-- Step 3: Generate -->
        <div class="card hidden" id="card-generate">
            <h2>Generating Pages...</h2>
            
            <div class="status info" id="status-generate">
                <span id="generate-status-text">Preparing files...</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <div class="preview-list" id="generate-list">
                <!-- Progress will be shown here -->
            </div>
            
            <div class="button-group hidden" id="download-buttons">
                <button class="btn btn-secondary" onclick="startOver()">Start Over</button>
                <button class="btn btn-primary" id="btn-download" onclick="downloadZip()">üì¶ Download ZIP</button>
            </div>
            
            <div class="hidden" id="instructions" style="margin-top: 20px; padding: 16px; background: #fff3cd; border-radius: 8px; font-size: 14px;">
                <strong>üìã How to add pages to Orchid:</strong>
                <ol style="margin: 12px 0 0 20px; line-height: 1.8;">
                    <li>Click <strong>Copy Code</strong> next to an item above</li>
                    <li>In Orchid, create a new page with the <strong>slug shown above</strong></li>
                    <li>Switch to <strong>Source Code</strong> view</li>
                    <li>Paste (Ctrl+V) and save</li>
                    <li>Repeat for each item</li>
                </ol>
                <p style="margin-top: 12px; font-size: 13px; color: #666;">You can also download all files as a ZIP if you prefer.</p>
            </div>
        </div>
    </div>

    <script>
    // Global state
    let csvData = [];
    let generatedFiles = [];
    let generatedZip = null;
    
    // Configuration
    let catalogUrl = '/auction-catalog';
    let baseUrl = '/';
    let ctaUrl = '';
    
    /* ==========================================================================
       SAVED AUCTIONS MANAGEMENT
       ========================================================================== */
    
    function loadSavedAuctions() {
        const saved = JSON.parse(localStorage.getItem('gea_saved_auctions') || '[]');
        const select = document.getElementById('saved-auctions');
        select.innerHTML = '<option value="">-- Select saved auction --</option>';
        saved.forEach((auction, idx) => {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = auction.name;
            select.appendChild(opt);
        });
    }
    
    function loadSavedAuction() {
        const select = document.getElementById('saved-auctions');
        const idx = select.value;
        if (idx === '') return;
        
        const saved = JSON.parse(localStorage.getItem('gea_saved_auctions') || '[]');
        if (saved[idx]) {
            document.getElementById('cta-url').value = saved[idx].url;
            document.getElementById('auction-name').value = saved[idx].name;
        }
    }
    
    function saveAuction() {
        const url = document.getElementById('cta-url').value.trim();
        const name = document.getElementById('auction-name').value.trim();
        
        if (!url || !name) {
            alert('Please enter both a URL and a name for this auction.');
            return;
        }
        
        const saved = JSON.parse(localStorage.getItem('gea_saved_auctions') || '[]');
        
        // Check if name already exists
        const existingIdx = saved.findIndex(a => a.name === name);
        if (existingIdx >= 0) {
            if (confirm(`"${name}" already exists. Update it with the new URL?`)) {
                saved[existingIdx].url = url;
            } else {
                return;
            }
        } else {
            saved.push({ name, url });
        }
        
        localStorage.setItem('gea_saved_auctions', JSON.stringify(saved));
        loadSavedAuctions();
        
        // Select the newly saved auction
        const select = document.getElementById('saved-auctions');
        const newIdx = saved.findIndex(a => a.name === name);
        select.value = newIdx;
        
        alert(`Auction "${name}" saved!`);
    }
    
    function deleteSavedAuction() {
        const select = document.getElementById('saved-auctions');
        const idx = select.value;
        if (idx === '') {
            alert('Please select a saved auction to delete.');
            return;
        }
        
        const saved = JSON.parse(localStorage.getItem('gea_saved_auctions') || '[]');
        const name = saved[idx]?.name;
        
        if (confirm(`Delete "${name}"?`)) {
            saved.splice(idx, 1);
            localStorage.setItem('gea_saved_auctions', JSON.stringify(saved));
            loadSavedAuctions();
            document.getElementById('cta-url').value = '';
            document.getElementById('auction-name').value = '';
        }
    }
    
    // Initialize saved auctions on page load
    document.addEventListener('DOMContentLoaded', loadSavedAuctions);
    
    /* ==========================================================================
       CSV PARSING
       ========================================================================== */
    
    function parseCSV(text) {
        const rows = [];
        let i = 0, field = '', row = [], inQuotes = false;
        
        while (i < text.length) {
            const c = text[i], n = text[i + 1];
            
            if (inQuotes) {
                if (c === '"' && n === '"') { field += '"'; i += 2; continue; }
                if (c === '"') { inQuotes = false; i++; continue; }
                field += c; i++; continue;
            }
            
            if (c === '"') { inQuotes = true; i++; continue; }
            if (c === ',') { row.push(field); field = ''; i++; continue; }
            if (c === '\n') { row.push(field); rows.push(row); field = ''; row = []; i++; continue; }
            if (c === '\r') { i++; continue; }
            
            field += c; i++;
        }
        
        if (field.length || row.length) { row.push(field); rows.push(row); }
        
        return rows;
    }
    
    function csvToObjects(rows) {
        if (rows.length < 2) return [];
        
        const headers = rows[0].map(h => h.trim());
        const objects = [];
        
        for (let i = 1; i < rows.length; i++) {
            const obj = {};
            headers.forEach((header, idx) => {
                obj[header] = rows[i][idx] || '';
            });
            // Only include rows that have a title
            if (obj['Title'] && obj['Title'].trim()) {
                objects.push(obj);
            }
        }
        
        return objects;
    }
    
    /* ==========================================================================
       STEP 1: LOAD DATA
       ========================================================================== */
    
    function toggleLoadMethod() {
        const method = document.querySelector('input[name="load-method"]:checked').value;
        document.getElementById('file-upload-section').style.display = method === 'file' ? 'block' : 'none';
        document.getElementById('url-load-section').style.display = method === 'url' ? 'block' : 'none';
    }
    
    async function loadData() {
        const method = document.querySelector('input[name="load-method"]:checked').value;
        const statusEl = document.getElementById('status-load');
        const btnLoad = document.getElementById('btn-load');
        
        // Get configuration
        catalogUrl = document.getElementById('catalog-url').value.trim() || '/auction-catalog';
        baseUrl = document.getElementById('base-url').value.trim() || '/';
        if (!baseUrl.endsWith('/')) baseUrl += '/';
        ctaUrl = document.getElementById('cta-url').value.trim();
        
        btnLoad.disabled = true;
        statusEl.className = 'status info';
        
        try {
            let csvText;
            
            if (method === 'file') {
                const fileInput = document.getElementById('csv-file');
                if (!fileInput.files || fileInput.files.length === 0) {
                    throw new Error('Please select a CSV file');
                }
                
                statusEl.textContent = 'Reading file...';
                csvText = await fileInput.files[0].text();
                
            } else {
                let csvUrl = document.getElementById('csv-url').value.trim();
                if (!csvUrl) {
                    throw new Error('Please enter a CSV URL');
                }
                
                // Convert edit URL to export URL if needed
                csvUrl = convertToExportUrl(csvUrl);
                
                // Use CORS proxy for Google Sheets
                if (csvUrl.includes('docs.google.com')) {
                    csvUrl = 'https://corsproxy.io/?' + encodeURIComponent(csvUrl);
                }
                
                statusEl.textContent = 'Loading data from Google Sheets...';
                const response = await fetch(csvUrl, { cache: 'no-store' });
                if (!response.ok) throw new Error('Failed to fetch CSV. Make sure the sheet is publicly accessible or use "Upload CSV file" instead.');
                csvText = await response.text();
            }
            
            const rows = parseCSV(csvText);
            csvData = csvToObjects(rows);
            
            if (csvData.length === 0) {
                throw new Error('No valid products found in spreadsheet');
            }
            
            statusEl.className = 'status success';
            statusEl.textContent = `Successfully loaded ${csvData.length} products!`;
            
            // Move to step 2
            setTimeout(() => showPreview(), 500);
            
        } catch (error) {
            statusEl.className = 'status error';
            statusEl.textContent = 'Error: ' + error.message;
            btnLoad.disabled = false;
        }
    }
    
    // Convert Google Sheets edit URL to export CSV URL
    function convertToExportUrl(url) {
        // Match Google Sheets URL patterns
        const match = url.match(/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
        if (!match) return url; // Not a Google Sheets URL, return as-is
        
        const sheetId = match[1];
        
        // Extract gid if present
        let gid = '0';
        const gidMatch = url.match(/[?&#]gid=(\d+)/);
        if (gidMatch) gid = gidMatch[1];
        
        // Return proper export URL
        return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
    }
    
    /* ==========================================================================
       STEP 2: PREVIEW
       ========================================================================== */
    
    function showPreview() {
        document.getElementById('card-load').classList.add('hidden');
        document.getElementById('card-preview').classList.remove('hidden');
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step1').classList.add('complete');
        document.getElementById('step2').classList.add('active');
        
        document.getElementById('item-count').textContent = csvData.length;
        
        const listEl = document.getElementById('preview-list');
        listEl.innerHTML = csvData.map((item, idx) => {
            const slug = getSlug(item, idx);
            return `
                <div class="preview-item">
                    <label>
                        <input type="checkbox" class="item-checkbox" data-index="${idx}" checked onchange="updateSelectedCount()">
                        <div>
                            <div class="title">${escapeHtml(item['Title'] || 'Untitled')}</div>
                            <div class="slug">Orchid slug: <strong>${slug}</strong></div>
                        </div>
                    </label>
                </div>
            `;
        }).join('');
        
        updateSelectedCount();
    }
    
    function selectAll() {
        document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = true);
        updateSelectedCount();
    }
    
    function selectNone() {
        document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
    }
    
    function updateSelectedCount() {
        const total = document.querySelectorAll('.item-checkbox').length;
        const selected = document.querySelectorAll('.item-checkbox:checked').length;
        document.getElementById('selected-count').textContent = `${selected} of ${total} selected`;
        document.getElementById('btn-generate').disabled = selected === 0;
    }
    
    function getSelectedIndices() {
        const indices = [];
        document.querySelectorAll('.item-checkbox:checked').forEach(cb => {
            indices.push(parseInt(cb.dataset.index));
        });
        return indices;
    }
    
    function goBack() {
        document.getElementById('card-preview').classList.add('hidden');
        document.getElementById('card-load').classList.remove('hidden');
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step1').classList.remove('complete');
        document.getElementById('step1').classList.add('active');
        document.getElementById('btn-load').disabled = false;
    }
    
    /* ==========================================================================
       STEP 3: GENERATE PAGES
       ========================================================================== */
    
    async function generatePages() {
        const selectedIndices = getSelectedIndices();
        
        if (selectedIndices.length === 0) {
            alert('Please select at least one item to generate.');
            return;
        }
        
        document.getElementById('card-preview').classList.add('hidden');
        document.getElementById('card-generate').classList.remove('hidden');
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step2').classList.add('complete');
        document.getElementById('step3').classList.add('active');
        
        generatedFiles = [];
        const zip = new JSZip();
        
        const listEl = document.getElementById('generate-list');
        const progressFill = document.getElementById('progress-fill');
        const statusText = document.getElementById('generate-status-text');
        
        // Build the list showing only selected items
        listEl.innerHTML = selectedIndices.map((idx, listPosition) => {
            const item = csvData[idx];
            const slug = getSlug(item, idx);
            return `
                <div class="preview-item" id="gen-item-${listPosition}">
                    <div>
                        <div class="title">${escapeHtml(item['Title'] || 'Untitled')}</div>
                        <div class="slug">Orchid slug: <strong>${slug}</strong></div>
                    </div>
                    <div class="status-icon pending" id="gen-status-${listPosition}">‚óã</div>
                </div>
            `;
        }).join('');
        
        // Generate each selected file
        for (let listPosition = 0; listPosition < selectedIndices.length; listPosition++) {
            const idx = selectedIndices[listPosition];
            const item = csvData[idx];
            const slug = getSlug(item, idx);
            const filename = `${slug}.html`;
            
            // Determine prev/next based on FULL spreadsheet order (not just selected items)
            const prevItem = idx > 0 ? csvData[idx - 1] : null;
            const nextItem = idx < csvData.length - 1 ? csvData[idx + 1] : null;
            
            const prevSlug = prevItem ? getSlug(prevItem, idx - 1) : null;
            const nextSlug = nextItem ? getSlug(nextItem, idx + 1) : null;
            
            const navigation = {
                prevURL: prevSlug ? `${baseUrl}${prevSlug}` : null,
                prevTitle: prevItem ? prevItem['Title'] : null,
                nextURL: nextSlug ? `${baseUrl}${nextSlug}` : null,
                nextTitle: nextItem ? nextItem['Title'] : null,
                catalogURL: catalogUrl
            };
            
            // Generate HTML content
            const htmlContent = generateProductHTML(item, navigation);
            
            // Add to zip
            zip.file(filename, htmlContent);
            generatedFiles.push({ filename, content: htmlContent });
            
            // Update UI
            document.getElementById(`gen-status-${listPosition}`).innerHTML = `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="copyCode(${listPosition})">Copy Code</button>`;
            document.getElementById(`gen-status-${listPosition}`).classList.remove('pending');
            document.getElementById(`gen-status-${listPosition}`).classList.add('complete');
            
            const progress = ((listPosition + 1) / selectedIndices.length) * 100;
            progressFill.style.width = progress + '%';
            statusText.textContent = `Processing ${listPosition + 1} of ${selectedIndices.length}...`;
            
            // Small delay for UI update
            await new Promise(r => setTimeout(r, 10));
        }
        
        // Store zip for download
        generatedZip = zip;
        
        // Complete
        statusText.textContent = `‚úì Successfully generated ${selectedIndices.length} product pages!`;
        document.getElementById('status-generate').classList.remove('info');
        document.getElementById('status-generate').classList.add('success');
        document.getElementById('download-buttons').classList.remove('hidden');
        document.getElementById('instructions').classList.remove('hidden');
        document.getElementById('step3').classList.remove('active');
        document.getElementById('step3').classList.add('complete');
    }
    
    function downloadZip() {
        if (!generatedZip) return;
        
        generatedZip.generateAsync({ type: 'blob' }).then(blob => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'product-pages.zip';
            link.click();
            URL.revokeObjectURL(link.href);
        });
    }
    
    function copyCode(index) {
        const content = generatedFiles[index].content;
        
        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(content).then(() => {
                showCopySuccess(index);
            }).catch(err => {
                // Fallback for iframe/security restrictions
                fallbackCopy(content, index);
            });
        } else {
            fallbackCopy(content, index);
        }
    }
    
    function fallbackCopy(content, index) {
        // Create a temporary textarea
        const textarea = document.createElement('textarea');
        textarea.value = content;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        textarea.style.top = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopySuccess(index);
            } else {
                showCopyModal(content);
            }
        } catch (err) {
            showCopyModal(content);
        }
        
        document.body.removeChild(textarea);
    }
    
    function showCopySuccess(index) {
        const btn = document.querySelector(`#gen-status-${index} button`);
        if (btn) {
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.style.background = '#4CAF50';
            btn.style.color = 'white';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
                btn.style.color = '';
            }, 1500);
        }
    }
    
    function showCopyModal(content) {
        // Create modal for manual copy
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
        modal.innerHTML = `
            <div style="background:#fff;border-radius:12px;padding:24px;max-width:600px;width:100%;max-height:80vh;display:flex;flex-direction:column;">
                <h3 style="margin:0 0 12px;">Copy Code Manually</h3>
                <p style="margin:0 0 12px;color:#666;font-size:14px;">Select all text below (Ctrl+A) and copy it (Ctrl+C):</p>
                <textarea style="flex:1;min-height:200px;font-family:monospace;font-size:11px;padding:12px;border:1px solid #ddd;border-radius:8px;resize:none;" readonly>${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                <button onclick="this.parentElement.parentElement.remove()" style="margin-top:12px;padding:12px 24px;background:#BAA342;color:#242424;border:none;border-radius:999px;font-weight:700;cursor:pointer;">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Auto-select the textarea content
        const textarea = modal.querySelector('textarea');
        textarea.focus();
        textarea.select();
    }
    
    function startOver() {
        location.reload();
    }
    
    /* ==========================================================================
       HTML GENERATION
       ========================================================================== */
    
    function getSlug(item, idx) {
        // Use the exact SEO Title/URL Slug value if present, otherwise generate from title
        const seoSlug = (item['SEO Title/URL Slug'] || '').trim();
        if (seoSlug) return seoSlug
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        // Fallback: generate slug from title
        return (item['Title'] || `item-${idx}`)
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function toImageUrl(token, size = 'w1600') {
        if (!token) return "";
        const t = String(token).trim();
        
        if (/^https?:\/\//i.test(t)) {
            if (/(?:\/folders\/)/i.test(t)) return t;
            
            let id = null;
            const m = t.match(/(?:\/d\/|[?&]id=)([A-Za-z0-9_-]{20,})/);
            if (m) id = m[1];
            if (!id) { 
                try { id = new URL(t).searchParams.get("id"); } catch(e) {} 
            }
            
            if (id) {
                if (size === 'original') {
                    return `https://drive.google.com/uc?export=view&id=${id}`;
                }
                return `https://drive.google.com/thumbnail?id=${id}&sz=${size}`;
            }
            return t;
        }
        
        if (size === 'original') {
            return `https://drive.google.com/uc?export=view&id=${encodeURIComponent(t)}`;
        }
        return `https://drive.google.com/thumbnail?id=${encodeURIComponent(t)}&sz=${size}`;
    }
    
    function collectImages(row) {
        const images = [];
        for (let i = 1; i <= 15; i++) {
            const col = i === 1 ? 'ImageURL' : `ImageURL${i}`;
            if (row[col] && row[col].trim()) {
                images.push(row[col].trim());
            }
        }
        return images;
    }
    
    function generateProductHTML(row, navigation) {
        const images = collectImages(row);
        
        // Parse arrays from newline-separated text
        const featureHighlights = row['Feature Highlights'] 
            ? row['Feature Highlights'].split(/\r?\n/).filter(line => line.trim())
            : [];
        
        const accessories = row['Accessories & Paperwork']
            ? row['Accessories & Paperwork'].split(/\r?\n/).filter(line => line.trim())
            : [];
        
        // Build the product data object as a string for embedding
        const productData = {
            seoSlug: row['SEO Title/URL Slug'] || '',
            title: row['Title'] || '',
            itemURL: row['ItemURL'] || '',
            images: images,
            overview: row['Overview'] || '',
            identification: {
                upc: row['UPC'] || '',
                make: row['Make'] || '',
                model: row['Model'] || '',
                serialNumber: row['SerialNumber'] || '',
                caliber: row['Caliber/Gauge'] || '',
                barrelLength: row['BarrelLength'] || '',
                origin: row['Origin'] || '',
                barrelMarkings: row['Barrel Markings'] || '',
                condition: (row['Condition'] || '').trim().toLowerCase() === 'used' 
                    ? `Used - ${(row['Condition Description'] || 'Unknown').trim()}` 
                    : (row['Condition'] || '').trim(),
                included: row['Included'] || ''
            },
            ipSummary: row['I&P Summary'] || '',
            conditionGrade: (row['Condition'] || '').trim().toLowerCase() === 'used' 
                ? `Used - ${(row['Condition Description'] || 'Unknown').trim()}` 
                : (row['Condition'] || '').trim(),
            conditionScale: parseFloat(row['Condition Scale']) || null,
            conditionParagraph: row['Condition Summary'] || '',
            mechanics: row['Mechanics'] || '',
            boreRating: parseFloat(row['Bore Rating']) || null,
            specs: {
                caliber: row['Caliber/Gauge'] || '',
                barrelLength: row['BarrelLength'] || '',
                actionType: row['Action Type'] || '',
                overallLength: row['Overal Length'] || '',
                chamber: row['Chamber'] || '',
                gasSystem: row['Gas System'] || '',
                sights: row['Sights'] || '',
                stock: row['Stock'] || '',
                receiver: row['Receiver'] || '',
                magazineCapacity: row['Magazine Capacity'] || ''
            },
            accessories: accessories,
            notesForBuyers: row['Notes For Buyers'] || '',
            featureHighlights: featureHighlights,
            marketNote: row['Market Note'] || '',
            navigation: navigation,
            ctaUrl: row['CTA URL'] || ctaUrl,  // Item-specific CTA URL with fallback to global
            currentHighBid: row['Current High Bid'] || '',
            proxibidHighBid: row['Proxibid High Bid'] || ''
        };
        
        return getProductTemplate(productData);
    }
    
    function getProductTemplate(data) {
        // Build navigation HTML
        const prevDisabled = !data.navigation.prevURL ? 'disabled' : '';
        const nextDisabled = !data.navigation.nextURL ? 'disabled' : '';
        const prevHref = data.navigation.prevURL || '#';
        const nextHref = data.navigation.nextURL || '#';
        
        return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${escapeHtml(data.title)} | Golden Eagle Auctions</title>
    
    <!-- Open Graph meta tags for link previews -->
    <meta property="og:title" content="${escapeHtml(data.title)}">
    <meta property="og:description" content="${escapeHtml(data.overview).substring(0, 200)}">
    <meta property="og:image" content="${data.images.length > 0 ? toImageUrl(data.images[0], 'w1200') : ''}">
    <meta property="og:url" content="">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <style>
        /* ========== CSS VARIABLES ========== */
        :root {
            --color-black: #242424;
            --color-gold: #BAA342;
            --color-gray-light: #F5F5F5;
            --color-gray-medium: #DDDDDD;
            --color-gray-text: #555555;
            --color-gray-muted: #777777;
            --color-white: #FFFFFF;
            --max-width: 1200px;
        }

        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--color-black);
            background-color: var(--color-white);
        }

        a {
            color: var(--color-gold);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        a:hover {
            color: var(--color-black);
        }

        img {
            max-width: 100%;
            height: auto;
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* ========== TOP NAVIGATION BAR ========== */
        .page-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-gray-medium);
            gap: 12px;
            flex-wrap: wrap;
        }

        .page-nav.bottom {
            margin-top: 30px;
            margin-bottom: 0;
            padding-top: 24px;
            padding-bottom: 0;
            border-bottom: none;
            border-top: 1px solid var(--color-gray-medium);
        }

        .nav-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: var(--color-gray-light);
            border-radius: 8px;
            color: var(--color-black);
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: var(--color-gold);
            color: var(--color-black);
        }

        .nav-btn.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .nav-btn i {
            font-size: 12px;
        }

        .back-btn {
            background: transparent;
            border: 1px solid var(--color-gray-medium);
        }

        .back-btn:hover {
            background: var(--color-gray-light);
            border-color: var(--color-gray-medium);
            color: var(--color-black);
        }

        .nav-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* ========== LOT TITLE ========== */
        .lot-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-black);
            margin-bottom: 24px;
            line-height: 1.3;
        }

        /* ========== IMAGE GALLERY ========== */
        .gallery-section {
            margin-bottom: 30px;
        }

        .main-image-container {
            position: relative;
            background: var(--color-white);
            border: 1px solid var(--color-gray-medium);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .main-image-wrapper {
            width: 100%;
            height: 500px;
            overflow: hidden;
            position: relative;
            cursor: default;
            touch-action: none;
        }

        .main-image-wrapper:active {
            cursor: default;
        }

        .main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
            user-select: none;
            -webkit-user-drag: none;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .zoom-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s ease;
        }

        .zoom-btn:hover {
            background: var(--color-black);
            color: var(--color-white);
        }

        .zoom-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Image Navigation Arrows */
        .image-nav-controls {
            position: absolute;
            bottom: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .image-nav-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s ease;
            color: var(--color-black);
        }

        .image-nav-btn:hover {
            background: var(--color-black);
            color: var(--color-white);
        }

        .zoom-hint {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 10;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .zoom-hint.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Image Counter */
        .image-counter {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            z-index: 10;
        }

        /* Thumbnail Strip */
        .thumbnail-strip {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 8px 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-gray-medium) transparent;
        }

        .thumbnail-strip::-webkit-scrollbar {
            height: 6px;
        }

        .thumbnail-strip::-webkit-scrollbar-track {
            background: transparent;
        }

        .thumbnail-strip::-webkit-scrollbar-thumb {
            background: var(--color-gray-medium);
            border-radius: 3px;
        }

        .thumbnail {
            flex: 0 0 80px;
            width: 80px;
            height: 80px;
            border: 2px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--color-white);
        }

        .thumbnail:hover {
            border-color: var(--color-gray-medium);
            transform: scale(1.05);
        }

        .thumbnail.active {
            border-color: var(--color-gold);
            box-shadow: 0 0 0 2px var(--color-gold);
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ========== CTA BUTTONS ========== */
        .cta-section {
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .cta-section.bottom {
            margin-top: 40px;
            margin-bottom: 20px;
            padding-top: 30px;
            border-top: 1px solid var(--color-gray-medium);
        }

        .cta-section.empty {
            display: none;
        }

        .high-bid-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .high-bid-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 16px 24px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-radius: 12px;
            border: 2px solid var(--color-gold);
            min-width: 180px;
        }

        .high-bid-display.proxibid {
            border-color: #00A651;
        }

        .high-bid-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--color-gold);
        }

        .high-bid-display.proxibid .high-bid-label {
            color: #00A651;
        }

        .high-bid-amount {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
        }

        .cta-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-block;
            padding: 14px 32px;
            border-radius: 999px;
            font-size: 16px;
            font-weight: 700;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background-color: var(--color-gold);
            color: var(--color-black);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn i {
            margin-right: 8px;
        }

        /* ========== CONTENT SECTIONS ========== */
        .content-section {
            background: var(--color-gray-light);
            border-radius: 10px;
            padding: 28px 32px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--color-black);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--color-gray-medium);
        }

        .section-content p {
            color: var(--color-gray-text);
            font-size: 15px;
            line-height: 1.8;
            margin-bottom: 16px;
        }

        .section-content p:last-child {
            margin-bottom: 0;
        }

        /* ========== SPECS TABLE ========== */
        .specs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px 32px;
        }

        .spec-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .spec-label {
            font-size: 13px;
            font-weight: 700;
            color: var(--color-gray-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .spec-value {
            font-size: 15px;
            color: var(--color-black);
        }

        .spec-paragraph {
            grid-column: 1 / -1;
            margin-top: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--color-gray-medium);
        }

        .spec-paragraph p {
            color: var(--color-gray-text);
            font-size: 15px;
            line-height: 1.8;
            font-style: italic;
        }

        /* ========== CONDITION DISPLAY ========== */
        .condition-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .condition-grade {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-black);
        }

        .condition-scale {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scale-bar {
            width: 120px;
            height: 10px;
            background: var(--color-gray-medium);
            border-radius: 5px;
            overflow: hidden;
        }

        .scale-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-gold), #d4c36a);
            border-radius: 5px;
        }

        .scale-number {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-gold);
        }

        /* ========== BORE RATING ========== */
        .bore-rating-display {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .bore-scale {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bore-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-gold);
        }

        .bore-max {
            font-size: 18px;
            color: var(--color-gray-muted);
        }

        /* ========== BULLET LISTS ========== */
        .bullet-list {
            list-style: disc;
            margin-left: 20px;
        }

        .bullet-list li {
            color: var(--color-gray-text);
            font-size: 15px;
            line-height: 1.8;
            margin-bottom: 8px;
        }

        .bullet-list li:last-child {
            margin-bottom: 0;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 900px) {
            .specs-grid {
                grid-template-columns: 1fr;
            }

            .main-image-wrapper {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .lot-title {
                font-size: 24px;
            }

            .main-image-wrapper {
                height: 300px;
            }

            .thumbnail {
                flex: 0 0 60px;
                width: 60px;
                height: 60px;
            }

            .content-section {
                padding: 20px;
            }

            .section-title {
                font-size: 18px;
            }

            .condition-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .page-nav {
                flex-direction: column;
                gap: 12px;
            }

            .nav-group {
                width: 100%;
                justify-content: space-between;
            }

            .nav-btn {
                flex: 1;
                justify-content: center;
            }

            .back-btn {
                width: 100%;
                justify-content: center;
            }

            .zoom-controls {
                bottom: 10px;
                right: 10px;
            }

            .image-nav-controls {
                bottom: 10px;
                left: 10px;
            }

            .zoom-btn,
            .image-nav-btn {
                width: 38px;
                height: 38px;
                font-size: 16px;
            }
        }

        @media (max-width: 600px) {
            .main-content {
                padding: 20px 15px;
            }
        }

        /* ========== HIDDEN UTILITY ========== */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
        
        <!-- Top Navigation -->
        <nav class="page-nav">
            <a href="${escapeHtml(data.navigation.catalogURL)}" class="nav-btn back-btn">
                <i class="fa fa-arrow-left"></i>
                <span>Back to Catalog</span>
            </a>
            <div class="nav-group">
                <a href="${escapeHtml(prevHref)}" class="nav-btn ${prevDisabled}">
                    <i class="fa fa-chevron-left"></i>
                    <span>Previous</span>
                </a>
                <a href="${escapeHtml(nextHref)}" class="nav-btn ${nextDisabled}">
                    <span>Next</span>
                    <i class="fa fa-chevron-right"></i>
                </a>
            </div>
        </nav>

        <!-- Lot Title -->
        <h1 class="lot-title">${escapeHtml(data.title)}</h1>

        <!-- Image Gallery -->
        <section class="gallery-section">
            <div class="main-image-container">
                <div class="zoom-hint" id="zoom-hint">
                    <i class="fa fa-search-plus"></i> Double-click to zoom, drag to pan
                </div>
                <div class="image-counter" id="image-counter">1 / ${data.images.length}</div>
                <div class="main-image-wrapper" id="main-image-wrapper">
                    <img src="${data.images.length > 0 ? toImageUrl(data.images[0], 'w1600') : ''}" alt="${escapeHtml(data.title)}" class="main-image" id="main-image" draggable="false">
                </div>
                <!-- Image Navigation Arrows -->
                <div class="image-nav-controls">
                    <button class="image-nav-btn" id="image-prev" title="Previous image">
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <button class="image-nav-btn" id="image-next" title="Next image">
                        <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
                <!-- Zoom Controls -->
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoom-out" title="Zoom out">‚àí</button>
                    <button class="zoom-btn" id="zoom-in" title="Zoom in">+</button>
                    <button class="zoom-btn" id="zoom-reset" title="Reset zoom">‚Ü∫</button>
                </div>
            </div>
            <div class="thumbnail-strip" id="thumbnail-strip">
                ${data.images.map((img, idx) => `
                    <button class="thumbnail ${idx === 0 ? 'active' : ''}" data-index="${idx}">
                        <img src="${toImageUrl(img, 'w400')}" alt="Thumbnail ${idx + 1}" loading="lazy">
                    </button>
                `).join('')}
            </div>
        </section>

        <!-- Top CTA -->
        <section class="cta-section${!data.currentHighBid && !data.proxibidHighBid && !data.ctaUrl ? ' empty' : ''}" id="cta-top">
            <div class="high-bid-row">
                <div class="high-bid-display" id="high-bid-top" ${data.currentHighBid ? '' : 'style="display:none;"'}>
                    <span class="high-bid-label">GEA Live High Bid</span>
                    <span class="high-bid-amount" id="bid-amount-top">${escapeHtml(data.currentHighBid || '')}</span>
                </div>
                <div class="high-bid-display proxibid" id="proxibid-bid-top" ${data.proxibidHighBid ? '' : 'style="display:none;"'}>
                    <span class="high-bid-label">Proxibid High Bid</span>
                    <span class="high-bid-amount" id="proxibid-amount-top">${escapeHtml(data.proxibidHighBid || '')}</span>
                </div>
            </div>
            <div class="cta-buttons">
                ${data.ctaUrl ? `
                <a href="${escapeHtml(data.ctaUrl)}" class="btn btn-primary cta-btn" target="_blank">
                    <i class="fa fa-gavel"></i> Bid Now
                </a>
                ` : '<a href="#" class="btn btn-primary cta-btn" id="cta-btn-top" style="display:none;" target="_blank"><i class="fa fa-gavel"></i> Bid Now</a>'}
            </div>
        </section>

        <!-- Overview -->
        ${data.overview ? `
        <section class="content-section">
            <h2 class="section-title">Overview</h2>
            <div class="section-content">
                <p>${escapeHtml(data.overview)}</p>
            </div>
        </section>
        ` : ''}

        <!-- Identification & Provenance -->
        ${generateIdentificationSection(data)}

        <!-- Condition Summary -->
        ${generateConditionSection(data)}

        <!-- Mechanics -->
        ${data.mechanics ? `
        <section class="content-section">
            <h2 class="section-title">Mechanics</h2>
            <div class="section-content">
                <p>${escapeHtml(data.mechanics)}</p>
            </div>
        </section>
        ` : ''}

        <!-- Bore Rating -->
        ${data.boreRating ? `
        <section class="content-section">
            <h2 class="section-title">Bore Rating</h2>
            <div class="section-content">
                <div class="bore-rating-display">
                    <div class="bore-scale">
                        <span class="bore-number">${data.boreRating}</span>
                        <span class="bore-max">/ 10</span>
                    </div>
                    <div class="scale-bar" style="width: 200px;">
                        <div class="scale-fill" style="width: ${(data.boreRating / 10) * 100}%;"></div>
                    </div>
                </div>
            </div>
        </section>
        ` : ''}

        <!-- Specs & Measurements -->
        ${generateSpecsSection(data)}

        <!-- Accessories & Paperwork -->
        ${data.accessories.length > 0 ? `
        <section class="content-section">
            <h2 class="section-title">Accessories & Paperwork</h2>
            <div class="section-content">
                <ul class="bullet-list">
                    ${data.accessories.map(item => `<li>${escapeHtml(item)}</li>`).join('')}
                </ul>
            </div>
        </section>
        ` : ''}

        <!-- Notes for Buyers -->
        ${data.notesForBuyers ? `
        <section class="content-section">
            <h2 class="section-title">Notes for Buyers</h2>
            <div class="section-content">
                <p>${escapeHtml(data.notesForBuyers)}</p>
            </div>
        </section>
        ` : ''}

        <!-- Feature Highlights -->
        ${data.featureHighlights.length > 0 ? `
        <section class="content-section">
            <h2 class="section-title">Feature Highlights</h2>
            <div class="section-content">
                <ul class="bullet-list">
                    ${data.featureHighlights.map(item => `<li>${escapeHtml(item)}</li>`).join('')}
                </ul>
            </div>
        </section>
        ` : ''}

        <!-- Market Note -->
        ${data.marketNote ? `
        <section class="content-section">
            <h2 class="section-title">Market Note</h2>
            <div class="section-content">
                <p>${escapeHtml(data.marketNote)}</p>
            </div>
        </section>
        ` : ''}

        <!-- Bottom CTA -->
        <section class="cta-section bottom${!data.currentHighBid && !data.proxibidHighBid && !data.ctaUrl ? ' empty' : ''}" id="cta-bottom">
            <div class="high-bid-row">
                <div class="high-bid-display" id="high-bid-bottom" ${data.currentHighBid ? '' : 'style="display:none;"'}>
                    <span class="high-bid-label">GEA Live High Bid</span>
                    <span class="high-bid-amount" id="bid-amount-bottom">${escapeHtml(data.currentHighBid || '')}</span>
                </div>
                <div class="high-bid-display proxibid" id="proxibid-bid-bottom" ${data.proxibidHighBid ? '' : 'style="display:none;"'}>
                    <span class="high-bid-label">Proxibid High Bid</span>
                    <span class="high-bid-amount" id="proxibid-amount-bottom">${escapeHtml(data.proxibidHighBid || '')}</span>
                </div>
            </div>
            <div class="cta-buttons">
                ${data.ctaUrl ? `
                <a href="${escapeHtml(data.ctaUrl)}" class="btn btn-primary cta-btn" target="_blank">
                    <i class="fa fa-gavel"></i> Bid Now
                </a>
                ` : '<a href="#" class="btn btn-primary cta-btn" id="cta-btn-bottom" style="display:none;" target="_blank"><i class="fa fa-gavel"></i> Bid Now</a>'}
            </div>
        </section>

        <!-- Bottom Navigation -->
        <nav class="page-nav bottom">
            <a href="${escapeHtml(data.navigation.catalogURL)}" class="nav-btn back-btn">
                <i class="fa fa-arrow-left"></i>
                <span>Back to Catalog</span>
            </a>
            <div class="nav-group">
                <a href="${escapeHtml(prevHref)}" class="nav-btn ${prevDisabled}">
                    <i class="fa fa-chevron-left"></i>
                    <span>Previous</span>
                </a>
                <a href="${escapeHtml(nextHref)}" class="nav-btn ${nextDisabled}">
                    <span>Next</span>
                    <i class="fa fa-chevron-right"></i>
                </a>
            </div>
        </nav>

    </main>

    <!-- ========== JAVASCRIPT ========== -->
    <script>
    const PRODUCT_IMAGES = ${JSON.stringify(data.images)};
    
    function toImageUrl(token, size) {
        if (!token) return "";
        const t = String(token).trim();
        if (/^https?:\\/\\//i.test(t)) {
            let id = null;
            const m = t.match(/(?:\\/d\\/|[?&]id=)([A-Za-z0-9_-]{20,})/);
            if (m) id = m[1];
            if (!id) { try { id = new URL(t).searchParams.get("id"); } catch(e) {} }
            if (id) {
                if (size === 'original') return "https://drive.google.com/uc?export=view&id=" + id;
                return "https://drive.google.com/thumbnail?id=" + id + "&sz=" + size;
            }
            return t;
        }
        if (size === 'original') return "https://drive.google.com/uc?export=view&id=" + encodeURIComponent(t);
        return "https://drive.google.com/thumbnail?id=" + encodeURIComponent(t) + "&sz=" + size;
    }

    let currentImageIndex = 0;
    let scale = 1, translateX = 0, translateY = 0;
    let isDragging = false, startX, startY, startTranslateX, startTranslateY;
    const MIN_SCALE = 1, MAX_SCALE = 4, SCALE_STEP = 0.5;

    const mainImage = document.getElementById('main-image');
    const mainImageWrapper = document.getElementById('main-image-wrapper');
    const thumbnailStrip = document.getElementById('thumbnail-strip');
    const imageCounter = document.getElementById('image-counter');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const zoomResetBtn = document.getElementById('zoom-reset');
    const zoomHint = document.getElementById('zoom-hint');
    const imagePrevBtn = document.getElementById('image-prev');
    const imageNextBtn = document.getElementById('image-next');

    // Image navigation
    function setActiveImage(index) {
        if (index < 0 || index >= PRODUCT_IMAGES.length) return;
        currentImageIndex = index;
        mainImage.src = toImageUrl(PRODUCT_IMAGES[index], 'w1600');
        resetZoom();
        thumbnailStrip.querySelectorAll('.thumbnail').forEach((thumb, i) => {
            thumb.classList.toggle('active', i === index);
        });
        const activeThumb = thumbnailStrip.querySelector('.thumbnail.active');
        if (activeThumb) activeThumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        imageCounter.textContent = (currentImageIndex + 1) + ' / ' + PRODUCT_IMAGES.length;
    }

    function navigateImage(direction) {
        let newIndex = currentImageIndex + direction;
        if (newIndex < 0) newIndex = PRODUCT_IMAGES.length - 1;
        if (newIndex >= PRODUCT_IMAGES.length) newIndex = 0;
        setActiveImage(newIndex);
    }

    imagePrevBtn.addEventListener('click', () => navigateImage(-1));
    imageNextBtn.addEventListener('click', () => navigateImage(1));

    thumbnailStrip.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.addEventListener('click', function() {
            setActiveImage(parseInt(this.dataset.index));
        });
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') navigateImage(-1);
        else if (e.key === 'ArrowRight') navigateImage(1);
    });

    // Zoom functions
    function zoom(delta) {
        const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale + delta));
        if (newScale !== scale) {
            scale = newScale;
            if (scale === 1) { translateX = 0; translateY = 0; }
            applyTransform();
            updateZoomUI();
        }
    }

    function resetZoom() {
        scale = 1; translateX = 0; translateY = 0;
        applyTransform();
        updateZoomUI();
    }

    function applyTransform() {
        mainImage.style.transform = 'translate(' + translateX + 'px, ' + translateY + 'px) scale(' + scale + ')';
    }

    function updateZoomUI() {
        zoomInBtn.disabled = scale >= MAX_SCALE;
        zoomOutBtn.disabled = scale <= MIN_SCALE;
    }

    function clampTranslation() {
        if (scale <= 1) { translateX = 0; translateY = 0; return; }
        const rect = mainImageWrapper.getBoundingClientRect();
        const maxX = (rect.width * (scale - 1)) / 2;
        const maxY = (rect.height * (scale - 1)) / 2;
        translateX = Math.max(-maxX, Math.min(maxX, translateX));
        translateY = Math.max(-maxY, Math.min(maxY, translateY));
    }

    zoomInBtn.addEventListener('click', () => zoom(SCALE_STEP));
    zoomOutBtn.addEventListener('click', () => zoom(-SCALE_STEP));
    zoomResetBtn.addEventListener('click', resetZoom);

    // Double-click to zoom
    mainImageWrapper.addEventListener('dblclick', function(e) {
        if (scale === 1) {
            const rect = mainImageWrapper.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            scale = 2.5;
            translateX = (centerX - clickX) * (scale - 1) / scale;
            translateY = (centerY - clickY) * (scale - 1) / scale;
            clampTranslation();
            applyTransform();
            updateZoomUI();
        } else {
            resetZoom();
        }
    });

    // Mouse drag for panning
    function startDrag(e) {
        if (scale <= 1) return;
        isDragging = true;
        startX = e.clientX; startY = e.clientY;
        startTranslateX = translateX; startTranslateY = translateY;
        mainImageWrapper.style.cursor = 'grabbing';
        e.preventDefault();
    }

    function drag(e) {
        if (!isDragging) return;
        translateX = startTranslateX + (e.clientX - startX);
        translateY = startTranslateY + (e.clientY - startY);
        clampTranslation();
        applyTransform();
    }

    function endDrag() {
        isDragging = false;
        mainImageWrapper.style.cursor = scale > 1 ? 'grab' : 'default';
    }

    mainImageWrapper.addEventListener('mousedown', startDrag);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', endDrag);

    // Touch handlers
    let touchStartDistance = null, touchStartScale = 1;
    let touchStartX = null, touchStartY = null, isSwiping = false;

    function getTouchDistance(touches) {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.hypot(dx, dy);
    }

    mainImageWrapper.addEventListener('touchstart', function(e) {
        if (e.touches.length === 2) {
            touchStartDistance = getTouchDistance(e.touches);
            touchStartScale = scale;
            isSwiping = false;
            e.preventDefault();
        } else if (e.touches.length === 1) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            if (scale > 1) {
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startTranslateX = translateX;
                startTranslateY = translateY;
                isSwiping = false;
            } else {
                isSwiping = true;
            }
        }
    }, { passive: false });

    mainImageWrapper.addEventListener('touchmove', function(e) {
        if (e.touches.length === 2 && touchStartDistance) {
            e.preventDefault();
            const currentDistance = getTouchDistance(e.touches);
            scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, touchStartScale * (currentDistance / touchStartDistance)));
            clampTranslation();
            applyTransform();
            updateZoomUI();
        } else if (e.touches.length === 1 && isDragging && scale > 1) {
            e.preventDefault();
            translateX = startTranslateX + (e.touches[0].clientX - startX);
            translateY = startTranslateY + (e.touches[0].clientY - startY);
            clampTranslation();
            applyTransform();
        }
    }, { passive: false });

    mainImageWrapper.addEventListener('touchend', function(e) {
        if (isSwiping && touchStartX !== null && scale <= 1 && e.changedTouches && e.changedTouches.length > 0) {
            const deltaX = e.changedTouches[0].clientX - touchStartX;
            const deltaY = e.changedTouches[0].clientY - touchStartY;
            if (Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY)) {
                navigateImage(deltaX > 0 ? -1 : 1);
            }
        }
        isDragging = false;
        isSwiping = false;
        touchStartDistance = null;
        touchStartX = null;
        touchStartY = null;
    });

    // Wheel zoom
    mainImageWrapper.addEventListener('wheel', function(e) {
        if (e.ctrlKey) {
            e.preventDefault();
            zoom(e.deltaY > 0 ? -SCALE_STEP : SCALE_STEP);
        }
    }, { passive: false });

    // Hide zoom hint
    mainImageWrapper.addEventListener('click', function() {
        zoomHint.classList.add('hidden');
    });
    zoomInBtn.addEventListener('click', function() {
        zoomHint.classList.add('hidden');
    });
    <\/script>

    <!-- Live Bid Update Script -->
    <script>
    (function() {
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1WFlVVSsMSpEx6s4YTUl7xvN_tbQe-oA-3fTZYqSVTgA/export?format=csv&gid=699359384';
        const PRODUCT_TITLE = ${JSON.stringify(data.title)};
        
        function parseCSV(text) {
            const rows = [];
            let i = 0, field = '', row = [], inQuotes = false;
            while (i < text.length) {
                const c = text[i], n = text[i + 1];
                if (inQuotes) {
                    if (c === '"' && n === '"') { field += '"'; i += 2; continue; }
                    if (c === '"') { inQuotes = false; i++; continue; }
                    field += c; i++; continue;
                }
                if (c === '"') { inQuotes = true; i++; continue; }
                if (c === ',') { row.push(field); field = ''; i++; continue; }
                if (c === '\\n') { row.push(field); rows.push(row); field = ''; row = []; i++; continue; }
                if (c === '\\r') { i++; continue; }
                field += c; i++;
            }
            if (field.length || row.length) { row.push(field); rows.push(row); }
            return rows;
        }
        
        function csvToObjects(rows) {
            if (rows.length < 2) return [];
            const headers = rows[0].map(h => h.trim());
            return rows.slice(1).map(row => {
                const obj = {};
                headers.forEach((h, i) => obj[h] = (row[i] || '').trim());
                return obj;
            });
        }
        
        async function updateLiveBid() {
            try {
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(SHEET_URL);
                const response = await fetch(proxyUrl, { cache: 'no-store' });
                if (!response.ok) return;
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                const items = csvToObjects(rows);
                
                // Find matching item by title
                const item = items.find(i => i['Title'] === PRODUCT_TITLE);
                if (!item) return;
                
                const highBid = item['Current High Bid'];
                const proxibidBid = item['Proxibid High Bid'];
                const ctaUrl = item['CTA URL'];
                
                // Update GEA Live bid displays
                if (highBid) {
                    const bidTop = document.getElementById('bid-amount-top');
                    const bidBottom = document.getElementById('bid-amount-bottom');
                    const displayTop = document.getElementById('high-bid-top');
                    const displayBottom = document.getElementById('high-bid-bottom');
                    
                    if (bidTop) bidTop.textContent = highBid;
                    if (bidBottom) bidBottom.textContent = highBid;
                    if (displayTop) displayTop.style.display = '';
                    if (displayBottom) displayBottom.style.display = '';
                    
                    // Show CTA sections
                    const ctaTop = document.getElementById('cta-top');
                    const ctaBottom = document.getElementById('cta-bottom');
                    if (ctaTop) ctaTop.classList.remove('empty');
                    if (ctaBottom) ctaBottom.classList.remove('empty');
                }
                
                // Update Proxibid bid displays
                if (proxibidBid) {
                    const proxibidTop = document.getElementById('proxibid-amount-top');
                    const proxibidBottom = document.getElementById('proxibid-amount-bottom');
                    const proxibidDisplayTop = document.getElementById('proxibid-bid-top');
                    const proxibidDisplayBottom = document.getElementById('proxibid-bid-bottom');
                    
                    if (proxibidTop) proxibidTop.textContent = proxibidBid;
                    if (proxibidBottom) proxibidBottom.textContent = proxibidBid;
                    if (proxibidDisplayTop) proxibidDisplayTop.style.display = '';
                    if (proxibidDisplayBottom) proxibidDisplayBottom.style.display = '';
                    
                    // Show CTA sections
                    const ctaTop = document.getElementById('cta-top');
                    const ctaBottom = document.getElementById('cta-bottom');
                    if (ctaTop) ctaTop.classList.remove('empty');
                    if (ctaBottom) ctaBottom.classList.remove('empty');
                }
                
                // Update CTA buttons if URL changed
                if (ctaUrl) {
                    const btnTop = document.getElementById('cta-btn-top');
                    const btnBottom = document.getElementById('cta-btn-bottom');
                    if (btnTop) { btnTop.href = ctaUrl; btnTop.style.display = ''; }
                    if (btnBottom) { btnBottom.href = ctaUrl; btnBottom.style.display = ''; }
                    
                    // Show CTA sections
                    const ctaTop = document.getElementById('cta-top');
                    const ctaBottom = document.getElementById('cta-bottom');
                    if (ctaTop) ctaTop.classList.remove('empty');
                    if (ctaBottom) ctaBottom.classList.remove('empty');
                }
                
            } catch (e) {
                console.log('Live bid update skipped:', e.message);
            }
        }
        
        // Update on page load
        updateLiveBid();
    })();
    <\/script>
</body>
</html>`;
    }
    
    function generateIdentificationSection(data) {
        const fields = [
            { key: 'upc', label: 'UPC/Stock Number' },
            { key: 'make', label: 'Make' },
            { key: 'model', label: 'Model' },
            { key: 'serialNumber', label: 'Serial Number' },
            { key: 'caliber', label: 'Caliber' },
            { key: 'barrelLength', label: 'Barrel Length' },
            { key: 'origin', label: 'Origin' },
            { key: 'barrelMarkings', label: 'Barrel Markings' },
            { key: 'condition', label: 'Condition' },
            { key: 'included', label: 'Included' }
        ];
        
        const validFields = fields.filter(f => data.identification[f.key] && data.identification[f.key].trim());
        if (validFields.length === 0 && !data.ipSummary) return '';
        
        return `
        <section class="content-section">
            <h2 class="section-title">Identification & Provenance</h2>
            <div class="section-content">
                <div class="specs-grid">
                    ${validFields.map(f => `
                        <div class="spec-item">
                            <span class="spec-label">${f.label}</span>
                            <span class="spec-value">${escapeHtml(data.identification[f.key])}</span>
                        </div>
                    `).join('')}
                </div>
                ${data.ipSummary ? `
                <div class="spec-paragraph">
                    <p>${escapeHtml(data.ipSummary)}</p>
                </div>
                ` : ''}
            </div>
        </section>
        `;
    }
    
    function generateConditionSection(data) {
        if (!data.conditionGrade && !data.conditionScale && !data.conditionParagraph) return '';
        
        return `
        <section class="content-section">
            <h2 class="section-title">Condition Summary</h2>
            <div class="section-content">
                <div class="condition-header">
                    ${data.conditionGrade ? `<span class="condition-grade">${escapeHtml(data.conditionGrade)}</span>` : ''}
                    ${data.conditionScale ? `
                    <div class="condition-scale">
                        <div class="scale-bar">
                            <div class="scale-fill" style="width: ${(data.conditionScale / 10) * 100}%;"></div>
                        </div>
                        <span class="scale-number">${data.conditionScale}/10</span>
                    </div>
                    ` : ''}
                </div>
                ${data.conditionParagraph ? `<p>${escapeHtml(data.conditionParagraph)}</p>` : ''}
            </div>
        </section>
        `;
    }
    
    function generateSpecsSection(data) {
        const fields = [
            { key: 'caliber', label: 'Caliber' },
            { key: 'barrelLength', label: 'Barrel Length' },
            { key: 'actionType', label: 'Action Type' },
            { key: 'overallLength', label: 'Overall Length' },
            { key: 'chamber', label: 'Chamber' },
            { key: 'gasSystem', label: 'Gas System' },
            { key: 'sights', label: 'Sights / Optics' },
            { key: 'stock', label: 'Stock' },
            { key: 'receiver', label: 'Receiver' },
            { key: 'magazineCapacity', label: 'Magazine Capacity' }
        ];
        
        const validFields = fields.filter(f => data.specs[f.key] && data.specs[f.key].trim());
        if (validFields.length === 0) return '';
        
        return `
        <section class="content-section">
            <h2 class="section-title">Specs & Measurements</h2>
            <div class="section-content">
                <div class="specs-grid">
                    ${validFields.map(f => `
                        <div class="spec-item">
                            <span class="spec-label">${f.label}</span>
                            <span class="spec-value">${escapeHtml(data.specs[f.key])}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </section>
        `;
    }
    </script>
</body>
</html>
