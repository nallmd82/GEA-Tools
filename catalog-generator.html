<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auction Catalog Generator - Golden Eagle Auctions</title>
    <style>
        :root {
            --color-black: #242424;
            --color-gold: #BAA342;
            --color-gray-light: #F5F5F5;
            --color-gray-medium: #DDDDDD;
            --color-gray-text: #555555;
        }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: var(--color-gray-light);
            margin: 0;
            padding: 24px;
            color: var(--color-black);
        }
        
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 8px; }
        .subtitle { text-align: center; color: var(--color-gray-text); margin-bottom: 32px; }
        
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .card h2 { margin-top: 0; margin-bottom: 20px; font-size: 20px; }
        
        label { display: block; font-weight: 600; margin-bottom: 6px; margin-top: 16px; }
        label:first-of-type { margin-top: 0; }
        
        input[type="url"], input[type="text"], input[type="number"], input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-gray-medium);
            border-radius: 8px;
            font-size: 14px;
        }
        
        .help-text { font-size: 13px; color: var(--color-gray-text); margin-top: 6px; }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .btn-primary { background: var(--color-gold); color: var(--color-black); }
        .btn-primary:hover { background: var(--color-black); color: #fff; }
        .btn-secondary { background: var(--color-gray-medium); color: var(--color-black); }
        .btn-secondary:hover { background: #ccc; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .button-group { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
        
        .status { padding: 12px 16px; border-radius: 8px; margin-top: 16px; display: none; }
        .status.info { background: #e3f2fd; color: #1565c0; display: block; }
        .status.success { background: #e8f5e9; color: #2e7d32; display: block; }
        .status.error { background: #ffebee; color: #c62828; display: block; }
        
        .hidden { display: none !important; }
        
        .preview-stats { background: var(--color-gray-light); padding: 16px; border-radius: 8px; margin-top: 16px; }
        .preview-stats h3 { margin: 0 0 12px 0; font-size: 16px; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-gray-medium); }
        .stat-row:last-child { border-bottom: none; }
        
        .code-output { margin-top: 20px; }
        .code-output textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 12px;
            padding: 12px;
            border: 1px solid var(--color-gray-medium);
            border-radius: 8px;
            resize: vertical;
        }
        
        .copy-feedback {
            display: inline-block;
            margin-left: 12px;
            color: #2e7d32;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .copy-feedback.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü¶Ö Catalog Page Generator</h1>
        <p class="subtitle">Generate the auction catalog page with filters for Golden Eagle Auctions</p>
        
        <!-- Step 1: Load Data -->
        <div class="card" id="card-load">
            <h2>1. Load Your Auction Data</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="font-weight: 600; margin-bottom: 8px; display: block;">Choose how to load data:</label>
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="load-method" value="file" checked onchange="toggleLoadMethod()"> Upload CSV file
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="load-method" value="url" onchange="toggleLoadMethod()"> Load from URL
                    </label>
                </div>
            </div>
            
            <div id="file-upload-section">
                <label for="csv-file">Select CSV File</label>
                <input type="file" id="csv-file" accept=".csv">
                <p class="help-text">Export your Google Sheet as CSV: File ‚Üí Download ‚Üí Comma-separated values (.csv)</p>
            </div>
            
            <div id="url-load-section" style="display: none;">
                <label for="csv-url">Google Sheet CSV URL</label>
                <input type="url" id="csv-url" placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv" value="https://docs.google.com/spreadsheets/d/1WFlVVSsMSpEx6s4YTUl7xvN_tbQe-oA-3fTZYqSVTgA/export?format=csv&gid=699359384">
                <p class="help-text">Paste the URL from your browser when viewing the Google Sheet. <strong>Note:</strong> URL loading only works when this page is hosted on a web server. If opening locally, use "Upload CSV file" instead.</p>
            </div>
            
            <label for="items-per-page">Items Per Page</label>
            <input type="number" id="items-per-page" value="48" min="10" max="200">
            <p class="help-text">Number of items to show per page (default: 48, divisible by 4 for even rows)</p>
            
            <button class="btn btn-primary" id="btn-load" onclick="loadData()">Load Data</button>
            
            <div class="status" id="status-load"></div>
        </div>
        
        <!-- Step 2: Preview & Generate -->
        <div class="card hidden" id="card-preview">
            <h2>2. Preview & Generate</h2>
            
            <div class="preview-stats" id="preview-stats">
                <h3>Data Summary</h3>
                <div class="stat-row"><span>Total Items:</span><strong id="stat-total">0</strong></div>
                <div class="stat-row"><span>Factory New:</span><strong id="stat-new">0</strong></div>
                <div class="stat-row"><span>Used:</span><strong id="stat-used">0</strong></div>
                <div class="stat-row"><span>Unique Makes:</span><strong id="stat-makes">0</strong></div>
                <div class="stat-row"><span>Classifications:</span><strong id="stat-class">0</strong></div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
                <button class="btn btn-primary" onclick="generateCatalog()">Generate Catalog Page</button>
            </div>
            
            <div class="status" id="status-generate"></div>
        </div>
        
        <!-- Step 3: Output -->
        <div class="card hidden" id="card-output">
            <h2>3. Copy Code to Orchid</h2>
            <p>Your catalog page has been generated! Copy the code below and paste it into Orchid's Source Code view.</p>
            <div class="code-output">
                <textarea id="code-output" readonly></textarea>
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="startOver()">Start Over</button>
                <button class="btn btn-primary" onclick="copyCode()">üìã Copy Code</button>
                <span class="copy-feedback" id="copy-feedback">Copied!</span>
            </div>
        </div>
    </div>

    <script>
    let csvData = [];
    let generatedCode = '';
    
    function toggleLoadMethod() {
        const method = document.querySelector('input[name="load-method"]:checked').value;
        document.getElementById('file-upload-section').style.display = method === 'file' ? 'block' : 'none';
        document.getElementById('url-load-section').style.display = method === 'url' ? 'block' : 'none';
    }
    
    function parseCSV(text) {
        const rows = [];
        let i = 0, field = "", row = [], inQuotes = false;
        while (i < text.length) {
            const c = text[i], n = text[i + 1];
            if (inQuotes) {
                if (c === '"' && n === '"') { field += '"'; i += 2; continue; }
                if (c === '"') { inQuotes = false; i++; continue; }
                field += c; i++; continue;
            }
            if (c === '"') { inQuotes = true; i++; continue; }
            if (c === ',') { row.push(field); field = ""; i++; continue; }
            if (c === '\n') { row.push(field); rows.push(row); field = ""; row = []; i++; continue; }
            if (c === '\r') { i++; continue; }
            field += c; i++;
        }
        if (field.length || row.length) { row.push(field); rows.push(row); }
        return rows;
    }
    
    function csvToObjects(rows) {
        if (rows.length < 2) return [];
        const headers = rows[0].map(h => h.trim());
        return rows.slice(1).map(row => {
            const obj = {};
            headers.forEach((h, i) => obj[h] = (row[i] || '').trim());
            return obj;
        }).filter(obj => obj['Title'] && obj['Title'].trim());
    }
    
    async function loadData() {
        const method = document.querySelector('input[name="load-method"]:checked').value;
        const statusEl = document.getElementById('status-load');
        const btnLoad = document.getElementById('btn-load');
        
        btnLoad.disabled = true;
        statusEl.className = 'status info';
        
        try {
            let csvText;
            if (method === 'file') {
                const fileInput = document.getElementById('csv-file');
                if (!fileInput.files || fileInput.files.length === 0) throw new Error('Please select a CSV file');
                statusEl.textContent = 'Reading file...';
                csvText = await fileInput.files[0].text();
            } else {
                let csvUrl = document.getElementById('csv-url').value.trim();
                if (!csvUrl) throw new Error('Please enter a CSV URL');
                
                // Convert edit URL to export URL if needed
                csvUrl = convertToExportUrl(csvUrl);
                
                statusEl.textContent = 'Loading data from Google Sheets...';
                const response = await fetch(csvUrl, { cache: 'no-store' });
                if (!response.ok) throw new Error('Failed to fetch CSV. If opening this file locally, use "Upload CSV file" instead (CORS restriction).');
                csvText = await response.text();
            }
            
            const rows = parseCSV(csvText);
            csvData = csvToObjects(rows);
            
            if (csvData.length === 0) throw new Error('No valid items found in spreadsheet');
            
            statusEl.className = 'status success';
            statusEl.textContent = `Successfully loaded ${csvData.length} items!`;
            
            setTimeout(() => showPreview(), 500);
        } catch (error) {
            statusEl.className = 'status error';
            statusEl.textContent = 'Error: ' + error.message;
            btnLoad.disabled = false;
        }
    }
    
    // Convert Google Sheets edit URL to export CSV URL
    function convertToExportUrl(url) {
        // Match Google Sheets URL patterns
        const match = url.match(/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
        if (!match) return url; // Not a Google Sheets URL, return as-is
        
        const sheetId = match[1];
        
        // Extract gid if present
        let gid = '0';
        const gidMatch = url.match(/[?&#]gid=(\d+)/);
        if (gidMatch) gid = gidMatch[1];
        
        // Return proper export URL
        return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
    }
    
    function showPreview() {
        document.getElementById('card-load').classList.add('hidden');
        document.getElementById('card-preview').classList.remove('hidden');
        
        const total = csvData.length;
        const factoryNew = csvData.filter(r => (r['Condition'] || '').toLowerCase() === 'factory new').length;
        const used = csvData.filter(r => (r['Condition'] || '').toLowerCase() === 'used').length;
        const makes = new Set(csvData.map(r => r['Make']).filter(Boolean)).size;
        const classifications = new Set(csvData.map(r => r['Classification']).filter(Boolean)).size;
        
        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-new').textContent = factoryNew;
        document.getElementById('stat-used').textContent = used;
        document.getElementById('stat-makes').textContent = makes;
        document.getElementById('stat-class').textContent = classifications;
    }
    
    function goBack() {
        document.getElementById('card-preview').classList.add('hidden');
        document.getElementById('card-load').classList.remove('hidden');
        document.getElementById('btn-load').disabled = false;
    }
    
    function startOver() { location.reload(); }
    
    function generateCatalog() {
        const statusEl = document.getElementById('status-generate');
        statusEl.className = 'status info';
        statusEl.textContent = 'Generating catalog page...';
        
        const itemsPerPage = parseInt(document.getElementById('items-per-page').value) || 50;
        
        // Build items with all needed fields
        const itemsJson = JSON.stringify(csvData.map(row => ({
            title: row['Title'] || '',
            seoSlug: row['SEO Title/URL Slug'] || '',
            make: row['Make'] || '',
            model: row['Model'] || '',
            condition: row['Condition'] || '',
            conditionDesc: row['Condition Description'] || '',
            caliber: row['Caliber/Gauge'] || '',
            classification: row['Classification'] || '',
            imageURL: row['ImageURL'] || '',
            description: row['Overview'] || row['Description'] || '',
            ctaUrl: row['CTA URL'] || '',
            currentHighBid: row['Current High Bid'] || ''
        })));
        
        // Extract unique values for filters
        const makes = [...new Set(csvData.map(r => r['Make']).filter(Boolean))].sort();
        const models = [...new Set(csvData.map(r => r['Model']).filter(Boolean))].sort();
        const calibers = [...new Set(csvData.map(r => r['Caliber/Gauge']).filter(Boolean))].sort();
        const classifications = [...new Set(csvData.map(r => r['Classification']).filter(Boolean))].sort();
        
        generatedCode = getCatalogTemplate(itemsJson, itemsPerPage, makes, models, calibers, classifications);
        
        statusEl.className = 'status success';
        statusEl.textContent = 'Catalog page generated successfully!';
        
        document.getElementById('card-preview').classList.add('hidden');
        document.getElementById('card-output').classList.remove('hidden');
        document.getElementById('code-output').value = generatedCode;
    }
    
    function copyCode() {
        navigator.clipboard.writeText(generatedCode).then(() => {
            const feedback = document.getElementById('copy-feedback');
            feedback.classList.add('show');
            setTimeout(() => feedback.classList.remove('show'), 2000);
        });
    }
    
    function getCatalogTemplate(itemsJson, itemsPerPage, makes, models, calibers, classifications) {
        return `<meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Auction Catalog</title>
<meta property="og:title" content="Auction Catalog" />
<meta property="og:description" content="Browse our auction inventory" />
<style type="text/css">
  :root { 
    --gap: 20px; 
    --card-radius: 14px; 
    --max: 1200px;
    --color-black: #242424;
    --color-gold: #BAA342;
    --color-gray-light: #F5F5F5;
    --color-gray-medium: #DDDDDD;
    --color-gray-text: #555555;
  }
  * { box-sizing: border-box; }
  body { font-family: Arial, sans-serif; margin: 0; padding: 24px; background: #fafafa; }
  
  /* Search and Filter Bar */
  .filter-section { max-width: var(--max); margin: 0 auto 20px; padding-top: 30px; }
  .search-row { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
  .search-row input[type="search"] { flex: 1 1 300px; padding: 12px 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
  .search-row .clear-btn { padding: 12px 20px; border: 1px solid #ddd; background: #fff; border-radius: 10px; cursor: pointer; font-size: 14px; }
  .search-row .clear-btn:hover { background: #f5f5f5; }
  .result-count { font-size: 14px; color: var(--color-gray-text); padding: 0 8px; }
  
  .filter-bar { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
  
  /* Multi-select dropdown */
  .filter-dropdown { position: relative; min-width: 160px; flex: 1 1 160px; max-width: 220px; }
  .filter-dropdown .dropdown-btn {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
    cursor: pointer;
    font-size: 14px;
    text-align: left;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .filter-dropdown .dropdown-btn:hover { border-color: #999; }
  .filter-dropdown .dropdown-btn.active { border-color: var(--color-gold); background: #fffdf5; }
  .filter-dropdown .dropdown-btn .arrow { transition: transform 0.2s; }
  .filter-dropdown.open .dropdown-btn .arrow { transform: rotate(180deg); }
  .filter-dropdown .badge { background: var(--color-gold); color: var(--color-black); font-size: 11px; font-weight: 700; padding: 2px 6px; border-radius: 10px; margin-left: 6px; }
  
  .dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 100;
    max-height: 280px;
    overflow: hidden;
    flex-direction: column;
  }
  .filter-dropdown.open .dropdown-menu { display: flex; }
  
  .dropdown-search { padding: 8px; border-bottom: 1px solid #eee; }
  .dropdown-search input { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
  
  .dropdown-options { overflow-y: auto; max-height: 220px; padding: 4px 0; }
  .dropdown-option { display: flex; align-items: center; padding: 8px 12px; cursor: pointer; font-size: 13px; }
  .dropdown-option:hover { background: #f5f5f5; }
  .dropdown-option input { margin-right: 8px; cursor: pointer; }
  .dropdown-option.selected { background: #fffdf5; }
  .dropdown-option .count { margin-left: auto; font-size: 11px; color: #999; }
  
  .dropdown-actions { display: flex; justify-content: space-between; padding: 8px; border-top: 1px solid #eee; }
  .dropdown-actions button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; background: #eee; }
  .dropdown-actions button:hover { background: #ddd; }
  
  /* Condition toggle buttons */
  .condition-filter { display: flex; gap: 8px; align-items: center; }
  .condition-filter span.label { font-size: 14px; font-weight: 600; margin-right: 4px; }
  .condition-btn {
    padding: 10px 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
  }
  .condition-btn:hover { border-color: #999; }
  .condition-btn.active { background: var(--color-gold); border-color: var(--color-gold); font-weight: 600; }
  
  /* Active filters display */
  .active-filters { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
  .active-filters:empty { display: none; }
  .filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--color-gray-light);
    border-radius: 20px;
    font-size: 12px;
  }
  .filter-tag .remove { cursor: pointer; font-weight: bold; opacity: 0.6; }
  .filter-tag .remove:hover { opacity: 1; }
  .clear-all-filters { padding: 6px 12px; background: none; border: 1px solid #ddd; border-radius: 20px; font-size: 12px; cursor: pointer; }
  .clear-all-filters:hover { background: #f5f5f5; }
  
  /* Pagination */
  .pagination { max-width: var(--max); margin: 20px auto; display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap; }
  .pagination button { padding: 8px 12px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s ease; min-width: 40px; }
  .pagination button:hover:not(:disabled) { background: #f5f5f5; border-color: #999; }
  .pagination button.active { background: var(--color-black); color: #fff; border-color: var(--color-black); }
  .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
  .pagination .page-info { padding: 0 12px; font-size: 14px; color: #666; }
  .items-info { max-width: var(--max); margin: 10px auto; text-align: center; font-size: 14px; color: #666; }
  
  /* Catalog grid */
  .catalog-container { max-width: var(--max); margin: 0 auto; display: grid; gap: var(--gap); grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
  .catalog-item { background: #fff; border: 1px solid #e9e9e9; border-radius: var(--card-radius); overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,.06); transition: transform .2s ease; display: flex; flex-direction: column; text-decoration: none; color: inherit; max-width: 320px; }
  .catalog-item:hover { transform: translateY(-3px); }
  .catalog-item .thumb { width: 100%; aspect-ratio: 4/3; background:#fff; position: relative; overflow: hidden; }
  .thumb img { width: 100%; height: 100%; object-fit: contain; background:#fff; }
  .catalog-item .pad { padding: 14px; display: flex; flex-direction: column; flex: 1; }
  .catalog-item h3 { margin: 6px 0 8px; font-size: 18px; color: var(--color-black); }
  .meta { font-size: 14px; color: var(--color-gray-text); margin-bottom: 10px; flex-grow: 1; }
  .high-bid { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 10px; margin-bottom: 12px; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); border-radius: 8px; border: 1px solid var(--color-gold); }
  .high-bid-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--color-gold); }
  .high-bid-amount { font-size: 18px; font-weight: 700; color: #fff; }
  .card-bottom { margin-top: auto; }
  .btn-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
  .btn { display: inline-block; background: var(--color-gold); color: var(--color-black); text-decoration: none; padding: 12px 24px; border-radius: 999px; font-weight: 700; font-size: 14px; transition: all 0.2s ease; border: none; cursor: pointer; }
  .btn:hover { background: var(--color-black); color: #fff; }
  .empty { max-width: var(--max); margin: 30px auto; color:#666; text-align:center; }
  
  @media (max-width: 768px) {
    .filter-bar { flex-direction: column; }
    .filter-dropdown { max-width: none; }
    .condition-filter { width: 100%; justify-content: flex-start; }
  }
  @media (max-width: 600px){
    body { padding: 12px; }
    .catalog-container { gap: 14px; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    .catalog-item { max-width: none; }
    .pagination button { padding: 6px 10px; font-size: 13px; min-width: 35px; }
    .catalog-item h3 { font-size: 16px; }
    .btn { padding: 10px 20px; font-size: 13px; }
    .high-bid { padding: 8px; }
    .high-bid-label { font-size: 9px; }
    .high-bid-amount { font-size: 16px; }
  }
</style>

<div class="filter-section">
  <div class="search-row">
    <input id="search" placeholder="Search by title, make, model, caliber..." type="search" />
    <button class="clear-btn" onclick="clearSearch()">Clear</button>
    <span class="result-count" id="result-count"></span>
  </div>
  
  <div class="filter-bar">
    <div class="filter-dropdown" id="filter-make">
      <button class="dropdown-btn" onclick="toggleDropdown('make')">
        <span>Make <span class="badge" id="badge-make" style="display:none">0</span></span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="dropdown-menu">
        <div class="dropdown-search"><input type="text" placeholder="Search makes..." oninput="searchInDropdown('make', this.value)"></div>
        <div class="dropdown-options" id="options-make"></div>
        <div class="dropdown-actions">
          <button onclick="selectAllVisible('make')">Select All</button>
          <button onclick="clearFilter('make')">Clear</button>
        </div>
      </div>
    </div>
    
    <div class="filter-dropdown" id="filter-model">
      <button class="dropdown-btn" onclick="toggleDropdown('model')">
        <span>Model <span class="badge" id="badge-model" style="display:none">0</span></span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="dropdown-menu">
        <div class="dropdown-search"><input type="text" placeholder="Search models..." oninput="searchInDropdown('model', this.value)"></div>
        <div class="dropdown-options" id="options-model"></div>
        <div class="dropdown-actions">
          <button onclick="selectAllVisible('model')">Select All</button>
          <button onclick="clearFilter('model')">Clear</button>
        </div>
      </div>
    </div>
    
    <div class="filter-dropdown" id="filter-caliber">
      <button class="dropdown-btn" onclick="toggleDropdown('caliber')">
        <span>Caliber <span class="badge" id="badge-caliber" style="display:none">0</span></span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="dropdown-menu">
        <div class="dropdown-search"><input type="text" placeholder="Search calibers..." oninput="searchInDropdown('caliber', this.value)"></div>
        <div class="dropdown-options" id="options-caliber"></div>
        <div class="dropdown-actions">
          <button onclick="selectAllVisible('caliber')">Select All</button>
          <button onclick="clearFilter('caliber')">Clear</button>
        </div>
      </div>
    </div>
    
    <div class="filter-dropdown" id="filter-classification">
      <button class="dropdown-btn" onclick="toggleDropdown('classification')">
        <span>Type <span class="badge" id="badge-classification" style="display:none">0</span></span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="dropdown-menu">
        <div class="dropdown-search"><input type="text" placeholder="Search types..." oninput="searchInDropdown('classification', this.value)"></div>
        <div class="dropdown-options" id="options-classification"></div>
        <div class="dropdown-actions">
          <button onclick="selectAllVisible('classification')">Select All</button>
          <button onclick="clearFilter('classification')">Clear</button>
        </div>
      </div>
    </div>
    
    <div class="condition-filter">
      <span class="label">Condition:</span>
      <button class="condition-btn" id="cond-new" onclick="toggleCondition('new')">Factory New</button>
      <button class="condition-btn" id="cond-used" onclick="toggleCondition('used')">Used</button>
    </div>
  </div>
  
  <div class="active-filters" id="active-filters"></div>
</div>

<div class="pagination" id="pagination-top"></div>
<div class="items-info" id="items-info-top"></div>
<div aria-live="polite" class="catalog-container" id="catalog"></div>
<div class="empty" id="empty" style="display:none;">No items match your filters.</div>
<div class="items-info" id="items-info-bottom"></div>
<div class="pagination" id="pagination-bottom"></div>

<script>
(function() {
  const ITEMS = ${itemsJson};
  const ITEMS_PER_PAGE = ${itemsPerPage};
  
  // All unique values for each filter (stored as arrays for index-based access)
  const OPTIONS = {
    make: ${JSON.stringify(makes)},
    model: ${JSON.stringify(models)},
    caliber: ${JSON.stringify(calibers)},
    classification: ${JSON.stringify(classifications)}
  };

  // State - store selected values as Sets for fast lookup
  const filters = {
    make: new Set(),
    model: new Set(),
    caliber: new Set(),
    classification: new Set(),
    condition: new Set()
  };
  
  let searchQuery = '';
  let searchTerms = { make: '', model: '', caliber: '', classification: '' };
  let filteredItems = [...ITEMS];
  let currentPage = 1;

  // Escape HTML for display
  function esc(s) {
    const div = document.createElement('div');
    div.textContent = s || '';
    return div.innerHTML;
  }

  function generateSlug(text) {
    if (!text) return '';
    return String(text).toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
  }

  function toImageUrl(token, size) {
    size = size || 'w400';
    if (!token) return "";
    const t = String(token).trim();
    if (/^https?:\\/\\//i.test(t)) {
      const m = t.match(/(?:\\/d\\/|[?&]id=)([A-Za-z0-9_-]{20,})/);
      if (m) return 'https://drive.google.com/thumbnail?id=' + m[1] + '&sz=' + size;
      return t;
    }
    return 'https://drive.google.com/thumbnail?id=' + encodeURIComponent(t) + '&sz=' + size;
  }

  function formatCondition(item) {
    const condition = (item.condition || '').trim();
    const conditionDesc = (item.conditionDesc || '').trim();
    if (condition.toLowerCase() === 'used' && conditionDesc) return 'Used - ' + conditionDesc;
    return condition;
  }

  // Get items matching all filters EXCEPT the specified one (for cascading counts)
  function getFilteredItemsExcept(exceptKey) {
    return ITEMS.filter(function(item) {
      if (searchQuery) {
        const searchText = [item.title, item.make, item.model, item.caliber, item.description, item.classification].join(' ').toLowerCase();
        if (searchText.indexOf(searchQuery) === -1) return false;
      }
      
      if (exceptKey !== 'make' && filters.make.size > 0) {
        if (!filters.make.has(item.make)) return false;
      }
      if (exceptKey !== 'model' && filters.model.size > 0) {
        if (!filters.model.has(item.model)) return false;
      }
      if (exceptKey !== 'caliber' && filters.caliber.size > 0) {
        if (!filters.caliber.has(item.caliber)) return false;
      }
      if (exceptKey !== 'classification' && filters.classification.size > 0) {
        if (!filters.classification.has(item.classification)) return false;
      }
      if (exceptKey !== 'condition' && filters.condition.size > 0) {
        const itemCond = (item.condition || '').toLowerCase();
        const isNew = itemCond === 'factory new';
        const isUsed = itemCond === 'used';
        const wantNew = filters.condition.has('new');
        const wantUsed = filters.condition.has('used');
        if (wantNew && wantUsed) { /* both selected, show all */ }
        else if (wantNew && !isNew) return false;
        else if (wantUsed && !isUsed) return false;
      }
      
      return true;
    });
  }

  // Get counts for each option value based on current filters
  function getOptionCounts(key) {
    const relevantItems = getFilteredItemsExcept(key);
    const counts = {};
    for (let i = 0; i < relevantItems.length; i++) {
      const val = relevantItems[i][key];
      if (val) counts[val] = (counts[val] || 0) + 1;
    }
    return counts;
  }

  // Update dropdown options with counts - hide unavailable options
  function updateDropdownOptions(key) {
    const container = document.getElementById('options-' + key);
    const counts = getOptionCounts(key);
    const searchTerm = searchTerms[key].toLowerCase();
    const options = OPTIONS[key];
    
    let html = '';
    for (let i = 0; i < options.length; i++) {
      const val = options[i];
      const count = counts[val] || 0;
      const isChecked = filters[key].has(val);
      const matchesSearch = !searchTerm || val.toLowerCase().indexOf(searchTerm) !== -1;
      
      // Hide options with 0 count unless they're already selected
      // Also hide if doesn't match search term
      if ((count === 0 && !isChecked) || !matchesSearch) continue;
      
      html += '<label class="dropdown-option' + 
        (isChecked ? ' selected' : '') + 
        '" data-idx="' + i + '">' +
        '<input type="checkbox"' + (isChecked ? ' checked' : '') + 
        ' onchange="handleFilter(\\'' + key + '\\',' + i + ',this.checked)"> ' +
        esc(val) +
        '<span class="count">(' + count + ')</span>' +
        '</label>';
    }
    container.innerHTML = html;
  }

  function updateAllDropdowns() {
    updateDropdownOptions('make');
    updateDropdownOptions('model');
    updateDropdownOptions('caliber');
    updateDropdownOptions('classification');
  }

  // Handle filter checkbox change
  window.handleFilter = function(key, idx, checked) {
    const val = OPTIONS[key][idx];
    if (checked) {
      filters[key].add(val);
    } else {
      filters[key].delete(val);
    }
    updateBadge(key);
    applyFilters();
    updateAllDropdowns();
  };

  window.toggleDropdown = function(key) {
    const dropdown = document.getElementById('filter-' + key);
    const wasOpen = dropdown.classList.contains('open');
    document.querySelectorAll('.filter-dropdown').forEach(function(d) { d.classList.remove('open'); });
    if (!wasOpen) {
      dropdown.classList.add('open');
      updateDropdownOptions(key);
    }
  };

  window.searchInDropdown = function(key, query) {
    searchTerms[key] = query;
    updateDropdownOptions(key);
  };

  window.selectAllVisible = function(key) {
    const options = document.querySelectorAll('#options-' + key + ' .dropdown-option input');
    options.forEach(function(cb) {
      if (!cb.checked) {
        cb.checked = true;
        const idx = parseInt(cb.parentElement.getAttribute('data-idx'));
        filters[key].add(OPTIONS[key][idx]);
      }
    });
    updateBadge(key);
    applyFilters();
    updateAllDropdowns();
  };

  window.clearFilter = function(key) {
    filters[key].clear();
    updateBadge(key);
    applyFilters();
    updateAllDropdowns();
  };

  function updateBadge(key) {
    const badge = document.getElementById('badge-' + key);
    const btn = document.querySelector('#filter-' + key + ' .dropdown-btn');
    const count = filters[key].size;
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = '';
      btn.classList.add('active');
    } else {
      badge.style.display = 'none';
      btn.classList.remove('active');
    }
  }

  window.toggleCondition = function(type) {
    const btn = document.getElementById('cond-' + type);
    if (filters.condition.has(type)) {
      filters.condition.delete(type);
      btn.classList.remove('active');
    } else {
      filters.condition.add(type);
      btn.classList.add('active');
    }
    applyFilters();
    updateAllDropdowns();
  };

  window.clearSearch = function() {
    document.getElementById('search').value = '';
    searchQuery = '';
    applyFilters();
    updateAllDropdowns();
  };

  window.clearAllFilters = function() {
    filters.make.clear();
    filters.model.clear();
    filters.caliber.clear();
    filters.classification.clear();
    filters.condition.clear();
    updateBadge('make');
    updateBadge('model');
    updateBadge('caliber');
    updateBadge('classification');
    document.querySelectorAll('.condition-btn').forEach(function(b) { b.classList.remove('active'); });
    document.getElementById('search').value = '';
    searchQuery = '';
    applyFilters();
    updateAllDropdowns();
  };

  window.removeFilterTag = function(key, idx) {
    const val = OPTIONS[key][idx];
    filters[key].delete(val);
    updateBadge(key);
    applyFilters();
    updateAllDropdowns();
  };

  function updateActiveFilters() {
    const container = document.getElementById('active-filters');
    let html = '';
    
    ['make', 'model', 'caliber', 'classification'].forEach(function(key) {
      filters[key].forEach(function(val) {
        const idx = OPTIONS[key].indexOf(val);
        html += '<span class="filter-tag">' + esc(val) + ' <span class="remove" onclick="removeFilterTag(\\'' + key + '\\',' + idx + ')">√ó</span></span>';
      });
    });
    
    if (filters.condition.has('new')) {
      html += '<span class="filter-tag">Factory New <span class="remove" onclick="toggleCondition(\\'new\\')">√ó</span></span>';
    }
    if (filters.condition.has('used')) {
      html += '<span class="filter-tag">Used <span class="remove" onclick="toggleCondition(\\'used\\')">√ó</span></span>';
    }
    
    if (html) {
      html += '<button class="clear-all-filters" onclick="clearAllFilters()">Clear All</button>';
    }
    
    container.innerHTML = html;
  }

  function applyFilters() {
    searchQuery = document.getElementById('search').value.trim().toLowerCase();
    
    filteredItems = ITEMS.filter(function(item) {
      // Search
      if (searchQuery) {
        const searchText = [item.title, item.make, item.model, item.caliber, item.description, item.classification].join(' ').toLowerCase();
        if (searchText.indexOf(searchQuery) === -1) return false;
      }
      
      // Make filter
      if (filters.make.size > 0 && !filters.make.has(item.make)) return false;
      
      // Model filter
      if (filters.model.size > 0 && !filters.model.has(item.model)) return false;
      
      // Caliber filter
      if (filters.caliber.size > 0 && !filters.caliber.has(item.caliber)) return false;
      
      // Classification filter
      if (filters.classification.size > 0 && !filters.classification.has(item.classification)) return false;
      
      // Condition filter
      if (filters.condition.size > 0) {
        const itemCond = (item.condition || '').toLowerCase();
        const isNew = itemCond === 'factory new';
        const isUsed = itemCond === 'used';
        const wantNew = filters.condition.has('new');
        const wantUsed = filters.condition.has('used');
        if (wantNew && wantUsed) { /* both, show all */ }
        else if (wantNew && !isNew) return false;
        else if (wantUsed && !isUsed) return false;
      }
      
      return true;
    });
    
    currentPage = 1;
    renderPage();
    renderPagination();
    updateActiveFilters();
    
    document.getElementById('result-count').textContent = filteredItems.length + ' items';
  }

  function renderPagination() {
    const totalItems = filteredItems.length;
    const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
    const $paginationTop = document.getElementById('pagination-top');
    const $paginationBottom = document.getElementById('pagination-bottom');
    const $itemsInfoTop = document.getElementById('items-info-top');
    const $itemsInfoBottom = document.getElementById('items-info-bottom');
    
    if (totalPages <= 1) {
      $paginationTop.innerHTML = "";
      $paginationBottom.innerHTML = "";
      $itemsInfoTop.innerHTML = "";
      $itemsInfoBottom.innerHTML = "";
      return;
    }
    
    const startItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
    const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
    const itemsInfo = 'Showing items ' + startItem + '-' + endItem + ' of ' + totalItems;
    $itemsInfoTop.innerHTML = itemsInfo;
    $itemsInfoBottom.innerHTML = itemsInfo;
    
    let html = '<button onclick="changePage(' + (currentPage - 1) + ')"' + (currentPage === 1 ? ' disabled' : '') + '>‚Äπ Prev</button>';
    
    if (totalPages <= 7) {
      for (let i = 1; i <= totalPages; i++) {
        html += '<button onclick="changePage(' + i + ')" class="' + (i === currentPage ? 'active' : '') + '">' + i + '</button>';
      }
    } else {
      html += '<button onclick="changePage(1)" class="' + (1 === currentPage ? 'active' : '') + '">1</button>';
      if (currentPage > 3) html += '<button disabled>...</button>';
      for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
        html += '<button onclick="changePage(' + i + ')" class="' + (i === currentPage ? 'active' : '') + '">' + i + '</button>';
      }
      if (currentPage < totalPages - 2) html += '<button disabled>...</button>';
      html += '<button onclick="changePage(' + totalPages + ')" class="' + (totalPages === currentPage ? 'active' : '') + '">' + totalPages + '</button>';
    }
    
    html += '<button onclick="changePage(' + (currentPage + 1) + ')"' + (currentPage === totalPages ? ' disabled' : '') + '>Next ‚Ä∫</button>';
    html += '<span class="page-info">Page ' + currentPage + ' of ' + totalPages + '</span>';
    
    $paginationTop.innerHTML = html;
    $paginationBottom.innerHTML = html;
  }

  window.changePage = function(page) {
    const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderPage();
    renderPagination();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  function renderPage() {
    const $catalog = document.getElementById('catalog');
    const $empty = document.getElementById('empty');
    const startIdx = (currentPage - 1) * ITEMS_PER_PAGE;
    const pageItems = filteredItems.slice(startIdx, startIdx + ITEMS_PER_PAGE);
    
    if (!pageItems.length) {
      $catalog.innerHTML = "";
      $empty.style.display = "block";
      return;
    }
    
    $empty.style.display = "none";
    let html = '';
    
    for (let i = 0; i < pageItems.length; i++) {
      const it = pageItems[i];
      const slug = generateSlug(it.seoSlug || it.title || '');
      const imgUrl = it.imageURL ? toImageUrl(it.imageURL) : '';
      const cond = formatCondition(it);
      
      html += '<a class="catalog-item" href="/' + slug + '">';
      if (imgUrl) {
        html += '<div class="thumb"><img referrerpolicy="no-referrer" src="' + imgUrl + '" alt="' + esc(it.title) + '" loading="lazy"></div>';
      } else {
        html += '<div class="thumb"></div>';
      }
      html += '<div class="pad"><h3>' + esc(it.title) + '</h3>';
      html += '<div class="meta">' + (cond ? 'Condition: ' + esc(cond) : '') + '</div>';
      html += '<div class="card-bottom">';
      if (it.currentHighBid) {
        html += '<div class="high-bid"><span class="high-bid-label">GEA Live High Bid</span><span class="high-bid-amount">' + esc(it.currentHighBid) + '</span></div>';
      }
      html += '<div class="btn-row"><span class="btn">View Details</span></div></div></div></a>';
    }
    
    $catalog.innerHTML = html;
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.filter-dropdown')) {
      document.querySelectorAll('.filter-dropdown').forEach(function(d) { d.classList.remove('open'); });
    }
  });

  // Search on input
  document.getElementById('search').addEventListener('input', function() {
    applyFilters();
    updateAllDropdowns();
  });

  // Initialize
  updateAllDropdowns();
  applyFilters();
})();
<` + `/script>`;
    }
    </script>
</body>
</html>
